<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>webmania</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Canvas del gioco -->
    <div id="game-container"></div>

    <!-- Interfaccia di Gioco -->
    <div id="ui-layer">
        <div id="timer">00:00.000</div>
        <div id="best-time">Best: --:--.---</div>
        <div id="countdown"></div>
        <div id="message"></div>
        <div id="error-log" style="color: red; background: rgba(0,0,0,0.8); display: none; padding: 10px; position: absolute; top:0; left:0; z-index:999;"></div>
    </div>
     <!-- Overlay Controlli Touch (In-Game) -->
    <div id="touch-controls" style="display: none;">
            <button class="touch-btn" data-action="left" id="btn-t-left">◄</button>
            <button class="touch-btn" data-action="right" id="btn-t-right">►</button>
            <button class="touch-btn" data-action="accel" id="btn-t-accel">▲</button>
            <button class="touch-btn" data-action="brake" id="btn-t-brake">▼</button>
            <button class="touch-btn small" data-action="pause" id="btn-t-pause">||</button>
            <button class="touch-btn small" data-action="cam" id="btn-t-cam">🎥</button>
            <button class="touch-btn small" data-action="toggleui" id="btn-t-toggle">👁</button>
        </div>
        <!-- Editor Touch (Visibile solo nelle opzioni) -->
        <div id="touch-editor-overlay" style="display: none; z-index: 3000; flex-direction: column;">
            <div class="editor-msg" style="position: relative; top: auto; margin-bottom: 20px;">
                TRASCINA PER SPOSTARE - CLICCA PER SELEZIONARE
            </div>
            <!-- Controlli Editor -->
            <div style="background: rgba(0,0,0,0.8); padding: 15px; border: 1px solid #fff; border-radius: 10px; z-index: 3010; pointer-events: auto;">
                <label style="color: white; font-size: 18px; display: block; margin-bottom: 5px;">Grandezza Tasto Selezionato</label>
                <input type="range" id="touch-size-slider" min="0.5" max="2.5" step="0.1" value="1.0" style="width: 200px;">
                <div id="selected-btn-name" style="color: #ffff00; text-align: center; margin-top: 5px; font-size: 14px;">Nessuno selezionato</div>
            </div>
            <button class="menu-btn secondary" style="margin-top: 20px; width:200px; pointer-events:auto; z-index: 3010;" onclick="window.uiCloseTouchEditor()">SALVA & ESCI</button>
        </div>

    <!-- Menu Principale (inizialmente visibile) -->
    <div id="main-menu" class="menu-overlay">
        <h1 class="game-title">WEBMANIA <span id="version-display"></span></h1>

        <!-- Schermata Home -->
        <div id="menu-home" class="menu-screen">
            <button class="menu-btn" onclick="window.uiOpenPlay()">GIOCA</button>
            <button class="menu-btn" onclick="window.uiOpenRecords()">RECORD</button>
            <button class="menu-btn" onclick="window.uiOpenOptions()">OPZIONI</button>
        </div>

        <!-- Schermata Gioca (Pista del Giorno + Input Seed) -->
        <div id="menu-play" class="menu-screen" style="display:none;">
            <h2>PISTA DEL GIORNO</h2>
            <button class="menu-btn primary" style="margin-bottom: 10px;" onclick="window.uiStartDailyGame()">GIOCA PISTA DEL GIORNO</button>
            <div style="width: 100%; height: 1px; background: #444; margin: 15px 0;"></div>
            <h2>OPPURE INSERISCI SEED</h2>
            <input type="text" id="seed-input" placeholder="Es: 12345" maxlength="20">
            <div class="btn-row">
                <button class="menu-btn secondary" onclick="window.uiBackToHome()">INDIETRO</button>
                <button class="menu-btn primary" onclick="window.uiStartGame()">INIZIA!</button>
            </div>
        </div>

        <!-- Schermata Importazione Replay Condiviso -->
        <div id="menu-import-confirm" class="menu-screen" style="display:none;">
            <h2 style="margin-bottom: 5px;">REPLAY CONDIVISO</h2>
            <div style="text-align: center; color: #ccc; margin-bottom: 20px;">
                <div id="import-meta-desc" style="color: #fff; font-weight:bold; font-size: 26px;"></div>
                <div id="import-meta-seed" style="color: #fff; font-size: 22px; font-weight: bold;">SEED: ???</div>
                <div id="import-meta-time" style="color: #ffd700; font-size: 20px;">TEMPO: --:--.---</div>
                <div id="import-meta-ver" style="font-size: 12px; margin-top: 10px;"></div>
            </div>
            <div class="btn-row">
                <button class="menu-btn secondary" onclick="window.uiCancelImport()">ANNULLA</button>
                <button class="menu-btn primary" onclick="window.uiConfirmImport()">SALVA & GUARDA</button>
            </div>
        </div>

        <!-- Schermata Record -->
        <div id="menu-records" class="menu-screen" style="display:none;">
            <h2>Record dei seed salvati</h2>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button class="menu-btn" style="font-size: 14px; padding: 10px;" onclick="window.uiTriggerImport()">IMPORTA</button>
                <button class="menu-btn" style="font-size: 14px; padding: 10px;" onclick="window.uiOpenExport()">ESPORTA</button>
            </div>
            <div id="records-list"></div>
            <button class="menu-btn secondary" onclick="window.uiBackToHome()">INDIETRO</button>
        </div>

        <!-- Schermata Opzioni Principale -->
        <div id="menu-options" class="menu-screen" style="display:none;">
            <h2>OPZIONI</h2>
            <button class="menu-btn" onclick="window.uiOpenSubMenu('opt-general')">IMPOSTAZIONI</button>
            <button class="menu-btn" onclick="window.uiOpenSubMenu('opt-controls')">COMANDI</button>
            <button class="menu-btn" onclick="window.uiOpenCustomize()">PERSONALIZZA AUTO</button>
            <button class="menu-btn" onclick="window.open('https://fibreditoniocartonio.github.io/', '_blank')">CREDITI</button>
            <button class="menu-btn secondary" onclick="window.uiBackToHome()">INDIETRO</button>
        </div>

        <!-- Schermata Personalizza Auto -->
        <div id="opt-customize" class="menu-screen" style="display:none; flex-direction: row; max-width: 900px; height: 500px; gap: 20px;">
            <!-- Colonna Controlli (Sinistra) -->
            <div style="flex: 1; display: flex; flex-direction: column; gap: 10px; justify-content: center;">
                <div class="setting-row">
                    <label>Carrozzeria</label>
                    <input type="color" id="col-body" oninput="window.updateCarColor('body', this.value)">
                </div>
                <div class="setting-row">
                    <label>Ruote</label>
                    <input type="color" id="col-wheels" oninput="window.updateCarColor('wheels', this.value)">
                </div>
                <div class="setting-row">
                    <label>Cerchioni</label>
                    <input type="color" id="col-rims" oninput="window.updateCarColor('rims', this.value)">
                </div>
                <div class="setting-row">
                    <label>Alettone</label>
                    <input type="color" id="col-spoiler" oninput="window.updateCarColor('spoiler', this.value)">
                </div>
                <div class="setting-row">
                    <label>Tachimetro</label>
                    <input type="color" id="col-speedo" oninput="window.updateCarColor('speedo', this.value)">
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="menu-btn primary" onclick="window.saveCustomize()">SALVA</button>
                    <button class="menu-btn" onclick="window.resetCustomize()">RESET</button>
                </div>
                <button class="menu-btn secondary" style="margin-top: 10px;" onclick="window.uiCloseCustomize()">INDIETRO</button>
            </div>
            <!-- Colonna Preview (Destra) -->
            <div id="car-preview-container" style="flex: 1; background: #000; border: 2px solid #555; position: relative; height:100%;">
                <div style="position: absolute; bottom: 0px; width: 100%; text-align: center; color: #fff; pointer-events: none; background: #000; ">PREVIEW AUTO</div>
            </div>
        </div>

        <!-- Sottomenu Generali -->
        <div id="opt-general" class="menu-screen" style="display:none;">
            <h2>GRAFICA</h2>
            <!-- Risoluzione Interna -->
            <div class="setting-row">
                <label>Risoluzione Interna</label>
                <input type="range" id="opt-render-height" min="144" max="1080" step="36" onchange="window.updateSetting('renderHeight', this.value)">
                <span id="val-render-height"></span>
            </div>
            <div class="setting-row">
                <label>FPS Massimi</label>
                <select id="opt-max-fps" onchange="window.updateSetting('maxFPS', this.value)" style="background: #222; color: #fff; border: 1px solid #555; font-family: inherit; font-size: 16px; padding: 5px;">
                    <option value="15">15 FPS</option>
                    <option value="20">20 FPS</option>
                    <option value="30">30 FPS</option>
                    <option value="60">60 FPS</option>
                </select>
            </div>
            <div class="setting-row">
                <label>Antialiasing (Richiede Ricarica pagina)</label>
                <input type="checkbox" id="opt-antialias" onchange="window.updateSetting('antialias', this.checked)">
            </div>
            <div class="setting-row">
                <label>Distanza Render (Fog)</label>
                <input type="range" id="opt-render-dist" min="50" max="1000" step="25" onchange="window.updateSetting('renderDistance', this.value)">
                <span id="val-render-dist"></span>
            </div>
            <div class="setting-row">
                <label>Quantità massima segni sgommate</label>
                <input type="range" id="opt-max-skids" min="0" max="500" step="10" onchange="window.updateSetting('maxSkidmarks', this.value)">
                <span id="val-max-skids"></span>
            </div>
            <h2>RECORDS</h2>
            <div class="setting-row">
                <label>Max Record Salvati</label>
                <input type="range" id="opt-max-records" min="25" max="1000" step="25" onchange="window.updateSetting('maxRecords', this.value)">
                <span id="val-max-records"></span>
            </div>
            <div class="setting-row">
                <label>Mostra Ghost Car dei Replay</label>
                <input type="checkbox" id="opt-ghost-enabled" onchange="window.updateSetting('ghostEnabled', this.checked)">
            </div>
            <div class="setting-row">
                <label>Chiedi di attivare lo Schermo Intero all'avvio</label>
                <input type="checkbox" id="opt-ask-fs" onchange="window.updateFsPref(this.checked)">
            </div>

            <h2>AUDIO</h2>
            <div class="setting-row">
                <label>Volume Musica</label>
                <input type="range" id="opt-vol-music" min="0" max="1" step="0.01" onchange="window.updateAudioSetting('musicVolume', this.value)">
                <span id="val-vol-music"></span>
            </div>
            <div class="setting-row">
                <label>Volume Effetti (SFX)</label>
                <input type="range" id="opt-vol-sfx" min="0" max="1" step="0.01" onchange="window.updateAudioSetting('sfxVolume', this.value)">
                <span id="val-vol-sfx"></span>
            </div>            

            <button class="menu-btn secondary" onclick="window.uiOpenOptions()">INDIETRO</button>
        </div>

        <!-- Sottomenu Comandi -->
        <div id="opt-controls" class="menu-screen" style="display:none;">
            <h2>COMANDI</h2>
            <button class="menu-btn" onclick="window.uiOpenSubMenu('opt-keys')">TASTIERA</button>
            <button class="menu-btn" onclick="window.uiOpenSubMenu('opt-gamepad')">CONTROLLER</button>
            <button class="menu-btn" onclick="window.uiOpenSubMenu('opt-touch')">TOUCH</button>
            <button class="menu-btn secondary" onclick="window.uiOpenOptions()">INDIETRO</button>
        </div>

        <!-- Controlli Tastiera -->
        <div id="opt-keys" class="menu-screen scrollable-menu" style="display:none;">
            <h2>TASTIERA</h2>
            <div id="key-binds-list"></div> <!-- Generato via JS -->
            <button class="menu-btn" onclick="window.resetKeysDefault()">RIPRISTINA DEFAULT</button>
            <button class="menu-btn secondary" onclick="window.uiOpenSubMenu('opt-controls')">INDIETRO</button>
        </div>

        <!-- Controlli Gamepad -->
        <div id="opt-gamepad" class="menu-screen" style="display:none;">
            <h2>CONTROLLER</h2>
            <div class="setting-row">
                <label>Abilita Controller</label>
                <input type="checkbox" id="chk-gamepad" onchange="window.updateSetting('gamepadEnabled', this.checked)">
            </div>
            <div id="gamepad-status" style="color: yellow; font-size: 14px; margin-bottom: 10px;">Nessun controller rilevato</div>
            <div id="gamepad-binds-list"></div>
            <button class="menu-btn" onclick="window.resetGamepadDefaults()">RIPRISTINA DEFAULT</button>
            <button class="menu-btn secondary" onclick="window.uiOpenSubMenu('opt-controls')">INDIETRO</button>
        </div>

        <!-- Controlli Touch -->
        <div id="opt-touch" class="menu-screen" style="display:none;">
            <h2>TOUCH</h2>
            <div class="setting-row">
                <label>Abilita Touch</label>
                <input type="checkbox" id="chk-touch" onchange="window.updateSetting('touchEnabled', this.checked)">
            </div>
            <button class="menu-btn" onclick="window.uiOpenTouchEditor()">MODIFICA TASTI TOUCH</button>
            <button class="menu-btn" onclick="window.resetTouchDefault()">RIPRISTINA LAYOUT DEFAULT</button>
            <button class="menu-btn secondary" onclick="window.uiOpenSubMenu('opt-controls')">INDIETRO</button>
        </div>

        <!-- Overlay Binding (Modale cattura tasto) -->
        <div id="binding-overlay" class="menu-overlay" style="display:none; background: rgba(0,0,0,0.9); z-index: 3000;">
            <h2 id="binding-msg">PREMI UN TASTO...</h2>
            <button class="menu-btn secondary" onclick="window.cancelBinding()">ANNULLA</button>
        </div>
    </div>

    <!-- Modale Pausa (In-Game) -->
    <div id="pause-modal" class="menu-overlay" style="display:none; background: rgba(0,0,0,0.6);">
        <div class="paused-box">
            <h2>PAUSA</h2>
            <button class="menu-btn" onclick="window.uiResume()">RIPRENDI</button>
            <div id="btn-respawn-div" style="display: none; flex-direction: row; gap: 15px;">
                <button class="menu-btn" style="text-wrap: nowrap;" onclick="window.uiRespawn('flying')">RESPAWN (FLYING)</button>
                <button class="menu-btn" style="text-wrap: nowrap;" onclick="window.uiRespawn('standing')">RESPAWN (STANDING)</button>
            </div>
            <button class="menu-btn" onclick="window.uiRestartTrack()">RICOMINCIA PISTA</button>
            <button id="btn-toggle-ghost" style="display: none;" class="menu-btn" onclick="window.toggleGhostInGame()">REPLAY GHOSTCAR: ON</button>
            <button class="menu-btn danger" onclick="window.uiExitToMenu()">TORNA AL MENU</button>
        </div>
    </div>

    <!-- Modal Schermo Intero -->
    <div id="fs-modal" class="menu-overlay" style="display:none; background: rgba(0,0,0,0.9);">
        <div class="paused-box">
            <h2>SCHERMO INTERO</h2>
            <p style="color: white; text-align: center;">Vuoi attivare lo schermo intero per una migliore esperienza?</p>
            <button class="menu-btn primary" onclick="window.uiSetFullscreen(true)">SÌ, ATTIVA</button>
            <button class="menu-btn" onclick="window.uiSetFullscreen(false)">NO, GRAZIE</button>
            <div style="margin-top: 15px;">
                <input type="checkbox" id="fs-dont-ask">
                <label style="color: #888; font-size: 14px;">Non chiedermelo più</label>
            </div>
        </div>
    </div>

    <!-- Modal Checkbox dei records -->
    <div id="selection-modal" class="menu-overlay" style="display:none; background: rgba(0,0,0,0.95); z-index: 4000;">
        <h2 id="selection-title">SELEZIONA RECORD</h2>
        <div id="selection-list" style="width: 90%; max-width: 600px; height: 50vh; overflow-y: auto; background: #222; border: 1px solid #444; margin-bottom: 20px;"></div>
        <div class="btn-row" style="flex-wrap: wrap; justify-content: center;">
            <button class="menu-btn secondary" style="width: auto;" onclick="document.getElementById('selection-modal').style.display='none'">ANNULLA</button>
            <button class="menu-btn" style="width: auto;" id="btn-toggle-select" onclick="window.uiToggleSelectAll()">DESELEZIONA TUTTI</button>
            <button class="menu-btn primary" style="width: auto;" id="btn-confirm-selection">CONFERMA</button>
        </div>
        <input type="file" id="import-file-input" style="display:none" accept=".json">
    </div>

    <!-- Import Map corretta per ES Modules -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
                "cannon-es": "https://esm.sh/cannon-es@0.20.0"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script type="module" src="javascript/script.js"></script>
</body>
</html>
